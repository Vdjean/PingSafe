<div class="container">
  <h1>Create New Ping</h1>

  <%= form_with model: @ping, local: true, html: { id: 'ping-form', multipart: true } do |f| %>
    <% if @ping.errors.any? %>
      <div class="alert alert-danger">
        <h4><%= pluralize(@ping.errors.count, "error") %> prohibited this ping from being saved:</h4>
        <ul>
          <% @ping.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Date/Time Configuration -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Date & Time</h5>

        <div class="mb-3">
          <%= f.label :date, class: "form-label" %>
          <%= f.date_field :date, class: "form-control", value: Date.today, required: true %>
        </div>

        <div class="mb-3">
          <%= f.label :heure, "Time", class: "form-label" %>
          <%= f.time_field :heure, class: "form-control", value: Time.now.strftime("%H:%M"), required: true %>
        </div>
      </div>
    </div>

    <% if params[:camera] == "true" %>
      <!-- Camera/Upload Section -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Photo</h5>

          <div class="d-grid gap-2 mb-3">
            <button type="button" class="btn btn-primary btn-lg" onclick="takePicture()">
              <i class="fa fa-camera"></i> Take Picture
            </button>
            <button type="button" class="btn btn-outline-primary btn-lg" onclick="uploadPicture()">
              <i class="fa fa-upload"></i> Upload Picture
            </button>
          </div>

          <!-- Hidden file input -->
          <input type="file"
                 accept="image/*"
                 class="d-none"
                 id="photo-input"
                 onchange="previewPhoto(event)">

          <!-- Hidden file input for camera -->
          <input type="file"
                 accept="image/*"
                 capture="environment"
                 class="d-none"
                 id="camera-input"
                 onchange="previewPhoto(event)">

          <!-- Hidden field to store base64 photo -->
          <%= f.hidden_field :photo, id: "photo-data" %>

          <!-- Photo Preview -->
          <div id="photo-preview" style="display: none;">
            <img id="preview-image" src="" alt="Photo preview" class="img-fluid rounded mb-2" style="max-height: 300px;">
            <p class="text-success"><i class="fa fa-check-circle"></i> Photo captured!</p>
          </div>

          <!-- Location status -->
          <div id="location-status" class="alert alert-info" style="display: none;">
            <i class="fa fa-location-arrow"></i> <span id="location-message">Getting your location...</span>
          </div>
        </div>
      </div>

      <!-- Additional Information Form -->
      <div class="card mb-3" id="details-form" style="display: none;">
        <div class="card-body">
          <h5 class="card-title">Details</h5>

          <div class="mb-3">
            <%= f.label :nombre_personnes, "Number of Persons", class: "form-label" %>
            <%= f.number_field :nombre_personnes,
                              class: "form-control",
                              placeholder: "How many people are involved?",
                              id: "nombre-personnes-input",
                              min: 0 %>
            <div class="form-text">Enter the number of persons</div>
          </div>

          <div class="mb-3">
            <%= f.label :signe_distinctif, "Distinguishing Sign", class: "form-label" %>
            <%= f.text_field :signe_distinctif,
                            class: "form-control",
                            id: "signe-distinctif-input",
                            placeholder: "Any distinctive features or signs..." %>
            <div class="form-text">Describe any distinguishing characteristics</div>
          </div>

          <div class="mb-3">
            <%= f.label :comment, "Comments", class: "form-label" %>
            <%= f.text_area :comment,
                           class: "form-control",
                           id: "additional-comments-input",
                           rows: 4,
                           placeholder: "Add any additional details or context..." %>
            <div class="form-text">Additional information about the situation</div>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Location status -->
      <div id="location-status" class="alert alert-info" style="display: none;">
        <i class="fa fa-location-arrow"></i> <span id="location-message">Getting your location...</span>
      </div>

      <!-- Details Form (No Camera Mode) -->
      <div class="card mb-3" id="details-form">
        <div class="card-body">
          <h5 class="card-title">Details</h5>

          <div class="mb-3">
            <%= f.label :nombre_personnes, "Number of Persons", class: "form-label" %>
            <%= f.number_field :nombre_personnes,
                              class: "form-control",
                              placeholder: "How many people are involved?",
                              id: "nombre-personnes-input",
                              min: 0 %>
            <div class="form-text">Enter the number of persons</div>
          </div>

          <div class="mb-3">
            <%= f.label :signe_distinctif, "Distinguishing Sign", class: "form-label" %>
            <%= f.text_field :signe_distinctif,
                            class: "form-control",
                            id: "signe-distinctif-input",
                            placeholder: "Any distinctive features or signs..." %>
            <div class="form-text">Describe any distinguishing characteristics</div>
          </div>

          <div class="mb-3">
            <%= f.label :comment, "Comments", class: "form-label" %>
            <%= f.text_area :comment,
                           class: "form-control",
                           id: "additional-comments-input",
                           rows: 4,
                           placeholder: "Add any additional details or context..." %>
            <div class="form-text">Additional information about the situation</div>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Hidden location fields (auto-filled) -->
    <%= f.hidden_field :latitude, id: "latitude-input" %>
    <%= f.hidden_field :longitude, id: "longitude-input" %>

    <div class="d-grid gap-2">
      <%= f.submit "Create Ping & Analyze", class: "btn btn-success btn-lg", id: "submit-btn", style: params[:camera] == "true" ? "display: none;" : "" %>
      <%= link_to "Cancel", root_path, class: "btn btn-outline-secondary" %>
    </div>
  <% end %>
</div>

<script>
  let locationCaptured = false;
  const cameraMode = <%= params[:camera] == "true" ? "true" : "false" %>;

  function takePicture() {
    // Trigger location capture
    captureLocation();
    // Open camera
    document.getElementById('camera-input').click();
  }

  function uploadPicture() {
    // Trigger location capture
    captureLocation();
    // Open file picker
    document.getElementById('photo-input').click();
  }

  function captureLocation() {
    const statusDiv = document.getElementById('location-status');
    const messageSpan = document.getElementById('location-message');

    statusDiv.style.display = 'block';
    statusDiv.className = 'alert alert-info';
    messageSpan.textContent = 'Getting your location...';

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          document.getElementById('latitude-input').value = position.coords.latitude;
          document.getElementById('longitude-input').value = position.coords.longitude;
          locationCaptured = true;

          statusDiv.className = 'alert alert-success';
          messageSpan.textContent = 'Location captured successfully!';

          // Hide after 2 seconds
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 2000);
        },
        function(error) {
          statusDiv.className = 'alert alert-danger';
          messageSpan.textContent = 'Error getting location: ' + error.message;
        }
      );
    } else {
      statusDiv.className = 'alert alert-danger';
      messageSpan.textContent = 'Geolocation is not supported by this browser.';
    }
  }

  function previewPhoto(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result;

        // Store base64 data in hidden field
        document.getElementById('photo-data').value = base64Data;

        // Show preview
        document.getElementById('preview-image').src = base64Data;
        document.getElementById('photo-preview').style.display = 'block';

        // Show the details form
        document.getElementById('details-form').style.display = 'block';

        // Show submit button
        document.getElementById('submit-btn').style.display = 'block';
      }
      reader.readAsDataURL(file);
    }
  }

  // Capture location when page loads (non-camera mode only)
  document.addEventListener('DOMContentLoaded', function() {
    if (!cameraMode) {
      captureLocation();
    }

    // Form validation before submit
    const form = document.getElementById('ping-form');
    form.addEventListener('submit', function(e) {
      const latitude = document.getElementById('latitude-input').value;
      const longitude = document.getElementById('longitude-input').value;

      if (!latitude || !longitude) {
        e.preventDefault();
        alert('Please wait for location to be captured before submitting.');
        captureLocation();
        return false;
      }

      console.log('Form submitting with:', {
        latitude: latitude,
        longitude: longitude,
        photo: document.getElementById('photo-data') ? document.getElementById('photo-data').value.substring(0, 50) + '...' : 'none'
      });
    });
  });
</script>

<div class="pingsafe-footer" data-map-footer-target="footer">
  <%= render "shared/footer2" %>
</div>
