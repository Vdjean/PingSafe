<div class="pingsafe-mobile-wrapper">

  <div class="pingsafe-form-ping-container">

    <div class="pingsafe-form-ping-header">

      <h1 class="pingsafe-form-ping-title">Create New Ping</h1>
      <div style="width: 40px;"></div>
    </div>

  <%= form_with model: @ping, local: true, html: { id: 'ping-form', multipart: true } do |f| %>
    <% if @ping.errors.any? %>
      <div class="pingsafe-form-error">
        <h4><%= pluralize(@ping.errors.count, "error") %> prohibited this ping from being saved:</h4>
        <ul>
          <% @ping.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

      <%= f.hidden_field :date, value: Date.today %>
      <%= f.hidden_field :heure, value: Time.now.strftime("%H:%M") %>

    <% if params[:camera] == "true" %>
        <div class="pingsafe-ping-form-card">
          <div class="pingsafe-ping-form-card-header">
            <div class="pingsafe-ping-form-icon pingsafe-icon-camera">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
            </div>
            <h3 class="pingsafe-ping-form-card-title">Photo <span style="font-size: 0.75rem; color: #9ca3af; font-weight: 400;">(Optional)</span></h3>
          </div>

          <div class="pingsafe-ping-form-body">
            <div class="pingsafe-photo-actions">
              <button type="button" class="pingsafe-photo-btn pingsafe-photo-btn-primary" onclick="takePicture()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                  <circle cx="12" cy="13" r="4"/>
                </svg>
                <span>Take Picture</span>
              </button>

              <button type="button" class="pingsafe-photo-btn pingsafe-photo-btn-secondary" onclick="uploadPicture()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <span>Upload Picture</span>
              </button>
            </div>


          <input type="file"
                 accept="image/*"
                 class="d-none"
                 id="photo-input"
                 onchange="previewPhoto(event)">

          <input type="file"
                 accept="image/*"
                 capture="environment"
                 class="d-none"
                 id="camera-input"
                 onchange="previewPhoto(event)">

          <%= f.hidden_field :photo, id: "photo-data" %>

          <div id="photo-preview" style="display: none;">
            <img id="preview-image" src="" alt="Photo preview" class="img-fluid rounded mb-2" style="max-height: 300px;">
            <p class="text-success"><i class="fa fa-check-circle"></i> Photo captured!</p>
          </div>
        </div>
      </div>

      <!-- Location status -->
      <div id="location-status" class="pingsafe-location-alert pingsafe-location-alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="location-icon">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4"/>
          <path d="M12 8h.01"/>
        </svg>
        <div class="pingsafe-location-alert-content">
          <p class="pingsafe-location-alert-text" id="location-message">Getting your location...</p>
        </div>
      </div>

      <!-- Information Form -->
      <div class="pingsafe-ping-form-card" id="details-form">

  <div class="pingsafe-ping-form-card-header">
    <div class="pingsafe-ping-form-icon pingsafe-icon-details">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
        <polyline points="10 9 9 9 8 9"/>
      </svg>
    </div>
    <h3 class="pingsafe-ping-form-card-title">Details</h3>
  </div>

  <div class="pingsafe-ping-form-body">

    <div class="pingsafe-form-group mb-3">
      <%= f.label :nombre_personnes, "Number of Persons", class: 'pingsafe-form-label' %>
      <%= f.number_field :nombre_personnes,
                        class: 'pingsafe-form-input',
                        placeholder: "How many people are involved?",
                        id: "nombre-personnes-input",
                        min: 0,
                        inputmode: "numeric",
                        pattern: "[0-9]*" %>
      <div class="form-text">* Enter the number of persons</div>
    </div>

    <div class="mb-3">
      <%= f.label :signe_distinctif, "Distinguishing Sign", class: 'pingsafe-form-label' %>
      <%= f.text_field :signe_distinctif,
                      class: 'pingsafe-form-input',
                      id: "signe-distinctif-input",
                      placeholder: "Any distinctive features or signs..." %>
      <div class="form-text">* Describe any distinguishing characteristics</div>
    </div>

    <div class="mb-3">
      <%= f.label :comment, "Comments", class: 'pingsafe-form-label' %>
      <%= f.text_area :comment,
                     class: 'pingsafe-form-input',
                     id: "additional-comments-input",
                     rows: 4,
                     placeholder: "Add any additional details or context..." %>
      <div class="form-text">* Additional information about the situation</div>
    </div>

  </div>
</div>

    <% else %>
      <div id="location-status" class="pingsafe-location-alert pingsafe-location-alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="location-icon">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4"/>
          <path d="M12 8h.01"/>
        </svg>
        <div class="pingsafe-location-alert-content">
          <p class="pingsafe-location-alert-text" id="location-message">Getting your location...</p>
        </div>
      </div>

      <div class="pingsafe-ping-form-card" id="details-form">
        <div class="pingsafe-ping-form-body ">
          <h5 class="pingsafe-form-ping-title">Details</h5>

          <div class="pingsafe-form-group mb-3">
            <%= f.label :nombre_personnes, "Number of Persons", class: 'pingsafe-form-label' %>
            <%= f.number_field :nombre_personnes,
                              class: "pingsafe-form-input",
                              placeholder: "How many people are involved?",
                              id: "nombre-personnes-input",
                              min: 0,
                              inputmode: "numeric",
                              pattern: "[0-9]*" %>
            <div class="form-text">* Enter the number of persons</div>
          </div>

           <div class="pingsafe-form-group mb-3">
            <%= f.label :signe_distinctif, "Distinguishing Sign", class: 'pingsafe-form-label' %>
            <%= f.text_field :signe_distinctif,
                            class: "pingsafe-form-input",
                            id: "signe-distinctif-input",
                            placeholder: "Any distinctive features or signs..." %>
            <div class="form-text">* Describe any distinguishing characteristics</div>
          </div>

          <div class="mb-3">
            <%= f.label :comment, "Comments", class: 'pingsafe-form-label' %>
            <%= f.text_area :comment,
                           class: "pingsafe-form-input",
                           id: "additional-comments-input",
                           rows: 4,
                           placeholder: "Add any additional details or context..." %>
            <div class="form-text">* Additional information about the situation</div>
          </div>
        </div>
      </div>
    <% end %>

    <%= f.hidden_field :latitude, id: "latitude-input" %>
    <%= f.hidden_field :longitude, id: "longitude-input" %>

      <div class="pingsafe-ping-form-actions">
        <%= f.submit "Create Ping & Analyze", class: "pingsafe-form-submit pingsafe-submit-ping", id: "submit-btn", disabled: true %>
        <%= link_to "Cancel", root_path, class: "pingsafe-form-cancel" %>
      </div>
  <% end %>

  </div>

<script>
  let locationCaptured = false;
  const cameraMode = <%= params[:camera] == "true" ? "true" : "false" %>;

  function takePicture() {
    if (!locationCaptured) {
      captureLocation();
    }
    document.getElementById('camera-input').click();
  }

  function uploadPicture() {
    if (!locationCaptured) {
      captureLocation();
    }
    document.getElementById('photo-input').click();
  }

  function enableSubmitButton() {
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-secondary');
      submitBtn.classList.add('btn-success');
    }
  }

  function disableSubmitButton() {
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.classList.remove('btn-success');
      submitBtn.classList.add('btn-secondary');
    }
  }

  function updateLocationAlert(type, message, showActions = false) {
    const statusDiv = document.getElementById('location-status');
    const messageSpan = document.getElementById('location-message');
    const iconSvg = document.getElementById('location-icon');

    statusDiv.style.display = 'flex';
    statusDiv.className = `pingsafe-location-alert pingsafe-location-alert-${type}`;
    messageSpan.textContent = message;

    // Update icon based on type
    if (type === 'success') {
      iconSvg.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';
    } else if (type === 'danger') {
      iconSvg.innerHTML = '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>';
    } else if (type === 'warning') {
      iconSvg.innerHTML = '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>';
    } else {
      iconSvg.innerHTML = '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>';
    }

    // Add action buttons if needed
    if (showActions) {
      const existingActions = statusDiv.querySelector('.pingsafe-location-alert-actions');
      if (existingActions) existingActions.remove();

      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'pingsafe-location-alert-actions';
      actionsDiv.innerHTML = `
        <button class="pingsafe-location-alert-btn pingsafe-location-alert-btn-primary" onclick="captureLocation()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
          </svg>
          Retry
        </button>
      `;
      statusDiv.querySelector('.pingsafe-location-alert-content').appendChild(actionsDiv);
    }
  }

  function captureLocation() {
    updateLocationAlert('info', 'Getting your location...');

    if (!window.isSecureContext && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      updateLocationAlert('warning', 'Secure connection required. Please use localhost.', true);
      showManualLocationInput();
      return;
    }

    if (!navigator.geolocation) {
      updateLocationAlert('danger', 'Geolocation not supported.', true);
      showManualLocationInput();
      return;
    }

    navigator.geolocation.getCurrentPosition(
      function(position) {
        document.getElementById('latitude-input').value = position.coords.latitude;
        document.getElementById('longitude-input').value = position.coords.longitude;
        locationCaptured = true;

        updateLocationAlert('success', 'Location captured successfully!');
        enableSubmitButton();

        setTimeout(() => {
          document.getElementById('location-status').style.display = 'none';
        }, 3000);
      },
      function(error) {
        let errorMessage = '';

        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = 'Location access denied. Please allow location access.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = 'Location unavailable. Please enable GPS.';
            break;
          case error.TIMEOUT:
            errorMessage = 'Location request timed out.';
            break;
          default:
            errorMessage = 'Unable to get location.';
        }

        updateLocationAlert('danger', errorMessage, true);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  }

  function showManualLocationInput() {
    const statusDiv = document.getElementById('location-status');
    const messageSpan = document.getElementById('location-message');

    statusDiv.className = 'alert alert-info';
    messageSpan.innerHTML = `
      <strong>Enter Location Manually</strong>
      <div class="row mt-2">
        <div class="col-6">
          <label class="form-label small">Latitude</label>
          <input type="number" step="any" class="form-control form-control-sm" id="manual-lat" placeholder="45.5017">
        </div>
        <div class="col-6">
          <label class="form-label small">Longitude</label>
          <input type="number" step="any" class="form-control form-control-sm" id="manual-lon" placeholder="-73.5673">
        </div>
      </div>
      <button class="btn btn-sm btn-success mt-2 w-100" onclick="saveManualLocation(event)">
        <i class="fa fa-check"></i> Use These Coordinates
      </button>
      <p class="small text-muted mb-0 mt-2">
        <i class="fa fa-info-circle"></i> You can find your coordinates on
        <a href="https://www.google.com/maps" target="_blank">Google Maps</a> by right-clicking your location.
      </p>
    `;
  }

  function saveManualLocation(e) {
    e.preventDefault();
    const lat = parseFloat(document.getElementById('manual-lat').value);
    const lon = parseFloat(document.getElementById('manual-lon').value);

    if (isNaN(lat) || isNaN(lon)) {
      updateLocationAlert('danger', 'Please enter valid coordinates.');
      return;
    }

    if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
      updateLocationAlert('danger', 'Invalid coordinates. Check your values.');
      return;
    }

    document.getElementById('latitude-input').value = lat;
    document.getElementById('longitude-input').value = lon;
    locationCaptured = true;

    updateLocationAlert('success', 'Location set manually!');
    enableSubmitButton();

    setTimeout(() => {
      document.getElementById('location-status').style.display = 'none';
    }, 3000);
  }

  function previewPhoto(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64Data = e.target.result;

        document.getElementById('photo-data').value = base64Data;

        document.getElementById('preview-image').src = base64Data;
        document.getElementById('photo-preview').style.display = 'block';
      }
      reader.readAsDataURL(file);
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    captureLocation();

    const form = document.getElementById('ping-form');
    form.addEventListener('submit', function(e) {
      const latitude = document.getElementById('latitude-input').value;
      const longitude = document.getElementById('longitude-input').value;

      if (!latitude || !longitude) {
        e.preventDefault();
        alert('Please wait for location to be captured before submitting.');
        captureLocation();
        return false;
      }

      console.log('Form submitting with:', {
        latitude: latitude,
        longitude: longitude,
        photo: document.getElementById('photo-data') ? document.getElementById('photo-data').value.substring(0, 50) + '...' : 'none'
      });
    });
  });

  document.addEventListener('turbo:load', function() {
    if (!locationCaptured) {
      captureLocation();
    }
  });
</script>
  <div class="pingsafe-lower-panel">
<div class="pingsafe-footer" data-map-footer-target="footer">
  <%= render "shared/footer2" %>
</div>
</div>
</div>
