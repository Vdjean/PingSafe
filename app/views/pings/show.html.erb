<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Ping Details</h1>
    <%= button_to "Refresh", ping_path(@ping), method: :get, class: "btn btn-sm btn-outline-primary" %>
  </div>

  <% if (@ping.photo.present? && @ping.blurred_photo_url.blank?) || (@chat.present? && @chat.danger_sites_json.blank?) %>
    <div class="alert alert-info">
      <i class="fa fa-spinner fa-spin"></i> AI is analyzing your location<%= @ping.photo.present? ? ' and photo' : '' %>... Page will auto-refresh.
    </div>
    <script>
      
      setTimeout(function() {
        window.location.reload();
      }, 3000);
    </script>
  <% end %>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Location Information</h5>
      <p><strong>Date:</strong> <%= @ping.date.strftime("%B %d, %Y") if @ping.date %></p>
      <p><strong>Time:</strong> <%= @ping.heure.strftime("%H:%M") if @ping.heure %></p>

      <div id="location-address">
        <p><strong>Location:</strong> <span id="address-text">Loading address...</span></p>
      </div>

      <% if @ping.comment.present? %>
        <p><strong>Comment:</strong> <%= simple_format(@ping.comment) %></p>
      <% end %>
    </div>
  </div>

  <% if @ping.photo.present? %>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Photo</h5>
        <% if @ping.blurred_photo_url.present? %>
          <p class="text-success mb-3">
            <i class="fa fa-check-circle"></i> Faces have been automatically blurred
          </p>
          <%= image_tag @ping.blurred_photo_url, class: "img-fluid rounded", alt: "Blurred photo" %>
        <% else %>
          <div class="text-center py-3">
            <i class="fa fa-spinner fa-spin fa-2x"></i>
            <p class="text-muted mt-2">Processing photo and blurring faces...</p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @chat.present? && @chat.danger_sites_json.present? %>
    <% begin %>
      <% sites = JSON.parse(@chat.danger_sites_json) %>
      <% # Filter out sites with no actual data %>
      <% valid_sites = sites.select { |site| site['name'].present? && site['name'] != 'Unknown Site' } if sites.is_a?(Array) %>

      <% if valid_sites&.any? %>
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fa fa-exclamation-triangle text-warning"></i> Nearby Safety Analysis
            </h5>
            <div class="list-group">
              <% valid_sites.each_with_index do |site, index| %>
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between align-items-start">
                    <h6 class="mb-1">
                      <%= index + 1 %>. <%= site['name'] %>
                    </h6>
                    <% danger_class = case site['danger_level']&.downcase
                      when 'high' then 'badge bg-danger'
                      when 'moderate' then 'badge bg-warning text-dark'
                      else 'badge bg-info'
                      end %>
                    <span class="<%= danger_class %>">
                      <%= site['danger_level']&.capitalize || 'Low' %>
                    </span>
                  </div>
                  <p class="mb-1 small">
                    <i class="fa fa-map-marker"></i> <%= site['distance_meters'] %> meters
                    <span class="text-muted mx-2">|</span>
                    <i class="fa fa-clock"></i> <%= site['walking_time'] %>
                  </p>
                  <p class="mb-0 small text-muted">
                    <strong>Risk:</strong> <%= site['risk_type']&.capitalize %>
                  </p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% rescue JSON::ParserError %>
      <!-- Invalid JSON, don't display anything -->
    <% end %>
  <% end %>

  <div class="d-grid gap-2 mb-3">
    <% if @ping.shared_at.present? %>
      <button class="btn btn-success btn-lg" disabled>
        <i class="fa fa-check-circle"></i> Shared on <%= @ping.shared_at.strftime("%B %d at %H:%M") %>
      </button>
    <% else %>
      <%= button_to share_ping_path(@ping), method: :post, class: "btn btn-primary btn-lg", data: { confirm: "Share this ping with the Pinger community within 300 meters?" } do %>
        <i class="fa fa-share-alt"></i> Share with Pinger
      <% end %>
    <% end %>
  </div>

  <%= link_to "Back to All Pings", pings_path, class: "btn btn-secondary" %>
</div>

<script>
  // Reverse geocoding to get address from coordinates
  const latitude = <%= @ping.latitude %>;
  const longitude = <%= @ping.longitude %>;

  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`)
    .then(response => response.json())
    .then(data => {
      const addressElement = document.getElementById('address-text');
      if (data.address) {
        const address = data.address;
        let shortAddress = [];

        // Add house number and street
        if (address.house_number) {
          shortAddress.push(address.house_number);
        }
        if (address.road || address.street) {
          shortAddress.push(address.road || address.street);
        }

        // Add city (try multiple possible keys)
        const city = address.city || address.town || address.village || address.municipality;
        if (city) {
          shortAddress.push(city);
        }

        // Add postcode
        if (address.postcode) {
          shortAddress.push(address.postcode);
        }

        if (shortAddress.length > 0) {
          addressElement.textContent = shortAddress.join(', ');
        } else {
          addressElement.textContent = data.display_name;
        }
        addressElement.classList.remove('text-muted');
      } else {
        addressElement.textContent = 'Address not available';
        addressElement.classList.add('text-muted');
      }
    })
    .catch(error => {
      console.error('Error fetching address:', error);
      document.getElementById('address-text').textContent = 'Unable to load address';
      document.getElementById('address-text').classList.add('text-muted');
    });
</script>

<div class="pingsafe-footer" data-map-footer-target="footer">
  <%= render "shared/footer2" %>
</div>

<!-- Share Success Modal -->
<div id="shareSuccessModal" class="pingsafe-modal">
  <div class="pingsafe-modal-overlay"></div>
  <div class="pingsafe-modal-content">
    <div class="pingsafe-modal-header">
      <div class="pingsafe-modal-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>
      <h2 class="pingsafe-modal-title">Congratulations!</h2>
      <p class="pingsafe-modal-subtitle">Your ping has been shared with the community</p>
    </div>

    <div class="pingsafe-modal-body">
      <div class="pingsafe-points-card">
        <div class="pingsafe-points-earned">
          <span class="pingsafe-points-label">Points Earned</span>
          <span class="pingsafe-points-value" id="pointsEarned">+10</span>
        </div>
        <div class="pingsafe-score-total">
          <span class="pingsafe-score-label">Total Score</span>
          <span class="pingsafe-score-value" id="totalScore">0</span>
        </div>
      </div>

      <div class="pingsafe-level-card" id="levelCard">
        <div class="pingsafe-level-info">
          <span class="pingsafe-level-label">Current Level</span>
          <div class="pingsafe-level-display">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2v20m0-20l9 4v8a9 9 0 0 1-9 9 9 9 0 0 1-9-9V6l9-4z"/>
            </svg>
            <span id="currentLevel" class="pingsafe-level-number">1</span>
          </div>
        </div>

        <div id="levelUpMessage" class="pingsafe-level-up" style="display: none;">
          <div class="pingsafe-level-up-icon">ðŸŽ‰</div>
          <p class="pingsafe-level-up-text">You leveled up!</p>
        </div>
      </div>
    </div>

    <div class="pingsafe-modal-footer">
      <button class="pingsafe-modal-btn" onclick="closeShareModal()">Continue</button>
    </div>
  </div>
</div>

<script>
  function closeShareModal() {
    const modal = document.getElementById('shareSuccessModal');
    modal.classList.remove('pingsafe-modal-show');

    // Redirect to homepage
    window.location.href = '/';
  }

  // Function to show modal
  function showShareModal() {
    const urlParams = new URLSearchParams(window.location.search);
    const pointsEarned = urlParams.get('points_earned');
    const newScore = urlParams.get('new_score');
    const newLevel = urlParams.get('new_level');
    const leveledUp = urlParams.get('leveled_up');

    if (pointsEarned) {
      // Update modal content
      document.getElementById('pointsEarned').textContent = '+' + pointsEarned;
      document.getElementById('totalScore').textContent = newScore;
      document.getElementById('currentLevel').textContent = newLevel;

      // Show level up message if applicable
      if (leveledUp === 'true') {
        document.getElementById('levelUpMessage').style.display = 'block';
      } else {
        document.getElementById('levelUpMessage').style.display = 'none';
      }

      // Show modal
      const modal = document.getElementById('shareSuccessModal');
      if (modal) {
        setTimeout(function() {
          modal.classList.add('pingsafe-modal-show');
        }, 100);
      }
    }
  }

  // Listen to both DOMContentLoaded and Turbo events
  document.addEventListener('DOMContentLoaded', showShareModal);
  document.addEventListener('turbo:load', showShareModal);
</script>
