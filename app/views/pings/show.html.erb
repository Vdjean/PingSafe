<div class="pingsafe-show-container">
  <div class="pingsafe-show-header">
    <h1 class="pingsafe-show-title">Ping Details</h1>
    <%= button_to ping_path(@ping), method: :get, class: "pingsafe-refresh-btn" do %>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="23 4 23 10 17 10"/>
        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
      </svg>
      Refresh
    <% end %>
  </div>

  <% if (@ping.photo.present? && @ping.blurred_photo_url.blank?) || (@chat.present? && @chat.danger_sites_json.blank?) %>
    <div class="alert alert-info pingsafe-show-alert">
      <i class="fa fa-spinner fa-spin"></i> AI is analyzing your location<%= @ping.photo.present? ? ' and photo' : '' %>... Page will auto-refresh.
    </div>
    <script>

      setTimeout(function() {
        window.location.reload();
      }, 3000);
    </script>
  <% end %>

  <!-- Map Card -->
  <div class="pingsafe-show-map-card">
    <div id="ping-show-map"></div>

    <div class="pingsafe-show-map-caption">
      <div class="pingsafe-map-caption-header">
        <div class="pingsafe-map-caption-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div class="pingsafe-map-caption-info">
          <h3 class="pingsafe-map-caption-title">Location</h3>
          <p class="pingsafe-map-caption-address" id="map-address-text">Loading address...</p>
        </div>
      </div>

      <div class="pingsafe-map-caption-details">
        <div class="pingsafe-map-detail-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <span><%= @ping.date.strftime("%B %d, %Y") if @ping.date %></span>
        </div>

        <div class="pingsafe-map-detail-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <span><%= @ping.heure.strftime("%H:%M") if @ping.heure %></span>
        </div>
      </div>

      <% if @ping.comment.present? %>
        <div class="pingsafe-map-caption-comment">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <p><%= simple_format(@ping.comment) %></p>
        </div>
      <% end %>
    </div>
  </div>

  <div class="pingsafe-show-content">
  <% if @ping.photo.present? %>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Photo</h5>
        <% if @ping.blurred_photo_url.present? %>
          <p class="text-success mb-3">
            <i class="fa fa-check-circle"></i> Faces have been automatically blurred
          </p>
          <%= image_tag @ping.blurred_photo_url, class: "img-fluid rounded", alt: "Blurred photo" %>
        <% else %>
          <div class="text-center py-3">
            <i class="fa fa-spinner fa-spin fa-2x"></i>
            <p class="text-muted mt-2">Processing photo and blurring faces...</p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @chat.present? && @chat.danger_sites_json.present? %>
    <% begin %>
      <% sites = JSON.parse(@chat.danger_sites_json) %>
      <% # Filter out sites with no actual data %>
      <% valid_sites = sites.select { |site| site['name'].present? && site['name'] != 'Unknown Site' } if sites.is_a?(Array) %>

      <% if valid_sites&.any? %>
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fa fa-exclamation-triangle text-warning"></i> Nearby Safety Analysis
            </h5>
            <div class="list-group">
              <% valid_sites.each_with_index do |site, index| %>
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between align-items-start">
                    <h6 class="mb-1">
                      <%= index + 1 %>. <%= site['name'] %>
                    </h6>
                    <% danger_class = case site['danger_level']&.downcase
                      when 'high' then 'badge bg-danger'
                      when 'moderate' then 'badge bg-warning text-dark'
                      else 'badge bg-info'
                      end %>
                    <span class="<%= danger_class %>">
                      <%= site['danger_level']&.capitalize || 'Low' %>
                    </span>
                  </div>
                  <p class="mb-1 small">
                    <i class="fa fa-map-marker"></i> <%= site['distance_meters'] %> meters
                    <span class="text-muted mx-2">|</span>
                    <i class="fa fa-clock"></i> <%= site['walking_time'] %>
                  </p>
                  <p class="mb-0 small text-muted">
                    <strong>Risk:</strong> <%= site['risk_type']&.capitalize %>
                  </p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% rescue JSON::ParserError %>
      <!-- Invalid JSON, don't display anything -->
    <% end %>
  <% end %>

  <div class="pingsafe-show-actions">
    <% if @ping.shared_at.present? %>
      <button class="pingsafe-share-btn pingsafe-share-btn-shared" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        Shared on <%= @ping.shared_at.strftime("%B %d at %H:%M") %>
      </button>
    <% else %>
      <%= button_to share_ping_path(@ping), method: :post, class: "pingsafe-share-btn", data: { confirm: "Share this ping with the Pinger community within 300 meters?" } do %>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="18" cy="5" r="3"/>
          <circle cx="6" cy="12" r="3"/>
          <circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        Share with Pinger
      <% end %>
    <% end %>

    <%= link_to pings_path, class: "pingsafe-back-btn", title: "Back to All Pings" do %>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"/>
        <polyline points="12 19 5 12 12 5"/>
      </svg>
    <% end %>
  </div>
  </div>
</div>

<script>
  // Initialize map for single ping display
  const latitude = <%= @ping.latitude %>;
  const longitude = <%= @ping.longitude %>;

  if (typeof mapboxgl !== 'undefined') {
    mapboxgl.accessToken = '<%= ENV['MAPBOX_TOKEN'] %>';

    const map = new mapboxgl.Map({
      container: 'ping-show-map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [longitude, latitude],
      zoom: 15
    });

    // Add geolocate control positioned just under the SOS button
    const geolocateControl = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: false,
      showUserHeading: true,
      showUserLocation: true
    });

    map.addControl(geolocateControl, 'bottom-right');

    // Add marker at ping location
    const el = document.createElement('div');
    el.style.width = '40px';
    el.style.height = '40px';
    el.style.backgroundImage = 'url(/fox-pin-full.png)';
    el.style.backgroundSize = 'contain';
    el.style.backgroundRepeat = 'no-repeat';
    el.style.backgroundPosition = 'center';

    new mapboxgl.Marker(el)
      .setLngLat([longitude, latitude])
      .addTo(map);
  }

  // Reverse geocoding to get address from coordinates

  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`)
    .then(response => response.json())
    .then(data => {
      const mapAddressElement = document.getElementById('map-address-text');

      if (data.address && mapAddressElement) {
        const address = data.address;
        let shortAddress = [];

        // Add house number and street
        if (address.house_number) {
          shortAddress.push(address.house_number);
        }
        if (address.road || address.street) {
          shortAddress.push(address.road || address.street);
        }

        // Add city (try multiple possible keys)
        const city = address.city || address.town || address.village || address.municipality;
        if (city) {
          shortAddress.push(city);
        }

        // Add postcode
        if (address.postcode) {
          shortAddress.push(address.postcode);
        }

        if (shortAddress.length > 0) {
          const formattedAddress = shortAddress.join(', ');
          mapAddressElement.textContent = formattedAddress;
        } else {
          mapAddressElement.textContent = data.display_name;
        }
      } else if (mapAddressElement) {
        mapAddressElement.textContent = 'Address not available';
      }
    })
    .catch(error => {
      console.error('Error fetching address:', error);
      const mapAddressElement = document.getElementById('map-address-text');
      if (mapAddressElement) {
        mapAddressElement.textContent = 'Unable to load address';
      }
    });
</script>

<div class="pingsafe-footer" data-map-footer-target="footer">
  <%= render "shared/footer2" %>
</div>

<!-- Share Success Modal -->
<div id="shareSuccessModal" class="pingsafe-modal">
  <div class="pingsafe-modal-overlay"></div>
  <div class="pingsafe-modal-content">
    <div class="pingsafe-modal-header">
      <div class="pingsafe-modal-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      </div>
      <h2 class="pingsafe-modal-title">Congratulations!</h2>
      <p class="pingsafe-modal-subtitle">Your ping has been shared with the community</p>
    </div>

    <div class="pingsafe-modal-body">
      <div class="pingsafe-points-card">
        <div class="pingsafe-points-earned">
          <span class="pingsafe-points-label">Points Earned</span>
          <span class="pingsafe-points-value" id="pointsEarned">+10</span>
        </div>
        <div class="pingsafe-score-total">
          <span class="pingsafe-score-label">Total Score</span>
          <span class="pingsafe-score-value" id="totalScore">0</span>
        </div>
      </div>

      <div class="pingsafe-level-card" id="levelCard">
        <div class="pingsafe-level-info">
          <span class="pingsafe-level-label">Current Level</span>
          <div class="pingsafe-level-display">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2v20m0-20l9 4v8a9 9 0 0 1-9 9 9 9 0 0 1-9-9V6l9-4z"/>
            </svg>
            <span id="currentLevel" class="pingsafe-level-number">1</span>
          </div>
        </div>

        <div id="levelUpMessage" class="pingsafe-level-up" style="display: none;">
          <div class="pingsafe-level-up-icon">ðŸŽ‰</div>
          <p class="pingsafe-level-up-text">You leveled up!</p>
        </div>
      </div>
    </div>

    <div class="pingsafe-modal-footer">
      <button class="pingsafe-modal-btn" onclick="closeShareModal()">Continue</button>
    </div>
  </div>
</div>

<script>
  function closeShareModal() {
    const modal = document.getElementById('shareSuccessModal');
    modal.classList.remove('pingsafe-modal-show');

    // Redirect to homepage
    window.location.href = '/';
  }

  // Function to show modal
  function showShareModal() {
    const urlParams = new URLSearchParams(window.location.search);
    const pointsEarned = urlParams.get('points_earned');
    const newScore = urlParams.get('new_score');
    const newLevel = urlParams.get('new_level');
    const leveledUp = urlParams.get('leveled_up');

    if (pointsEarned) {
      // Update modal content
      document.getElementById('pointsEarned').textContent = '+' + pointsEarned;
      document.getElementById('totalScore').textContent = newScore;
      document.getElementById('currentLevel').textContent = newLevel;

      // Show level up message if applicable
      if (leveledUp === 'true') {
        document.getElementById('levelUpMessage').style.display = 'block';
      } else {
        document.getElementById('levelUpMessage').style.display = 'none';
      }

      // Show modal
      const modal = document.getElementById('shareSuccessModal');
      if (modal) {
        setTimeout(function() {
          modal.classList.add('pingsafe-modal-show');
        }, 100);
      }
    }
  }

  // Listen to both DOMContentLoaded and Turbo events
  document.addEventListener('DOMContentLoaded', showShareModal);
  document.addEventListener('turbo:load', showShareModal);
</script>
