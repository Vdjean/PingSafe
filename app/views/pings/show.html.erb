<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Ping Details</h1>
    <%= button_to "Refresh", ping_path(@ping), method: :get, class: "btn btn-sm btn-outline-primary" %>
  </div>

  <% if (@ping.photo.present? && @ping.blurred_photo_url.blank?) || (@chat.present? && @chat.danger_sites_json.blank?) %>
    <div class="alert alert-info">
      <i class="fa fa-spinner fa-spin"></i> AI is analyzing your location<%= @ping.photo.present? ? ' and photo' : '' %>... Page will auto-refresh.
    </div>
    <script>
      // Auto-refresh every 3 seconds while processing
      setTimeout(function() {
        window.location.reload();
      }, 3000);
    </script>
  <% end %>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Location Information</h5>
      <p><strong>Date:</strong> <%= @ping.date.strftime("%B %d, %Y") if @ping.date %></p>
      <p><strong>Time:</strong> <%= @ping.heure.strftime("%H:%M") if @ping.heure %></p>

      <div id="location-address">
        <p><strong>Location:</strong> <span id="address-text">Loading address...</span></p>
      </div>

      <% if @ping.comment.present? %>
        <p><strong>Comment:</strong> <%= simple_format(@ping.comment) %></p>
      <% end %>
    </div>
  </div>

  <% if @ping.photo.present? %>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Photo</h5>
        <% if @ping.blurred_photo_url.present? %>
          <p class="text-success mb-3">
            <i class="fa fa-check-circle"></i> Faces have been automatically blurred
          </p>
          <%= image_tag @ping.blurred_photo_url, class: "img-fluid rounded", alt: "Blurred photo" %>
        <% else %>
          <div class="text-center py-3">
            <i class="fa fa-spinner fa-spin fa-2x"></i>
            <p class="text-muted mt-2">Processing photo and blurring faces...</p>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @chat.present? && @chat.danger_sites_json.present? %>
    <% begin %>
      <% sites = JSON.parse(@chat.danger_sites_json) %>
      <% # Filter out sites with no actual data %>
      <% valid_sites = sites.select { |site| site['name'].present? && site['name'] != 'Unknown Site' } if sites.is_a?(Array) %>

      <% if valid_sites&.any? %>
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fa fa-exclamation-triangle text-warning"></i> Nearby Safety Analysis
            </h5>
            <div class="list-group">
              <% valid_sites.each_with_index do |site, index| %>
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between align-items-start">
                    <h6 class="mb-1">
                      <%= index + 1 %>. <%= site['name'] %>
                    </h6>
                    <% danger_class = case site['danger_level']&.downcase
                      when 'high' then 'badge bg-danger'
                      when 'moderate' then 'badge bg-warning text-dark'
                      else 'badge bg-info'
                      end %>
                    <span class="<%= danger_class %>">
                      <%= site['danger_level']&.capitalize || 'Low' %>
                    </span>
                  </div>
                  <p class="mb-1 small">
                    <i class="fa fa-map-marker"></i> <%= site['distance_meters'] %> meters
                    <span class="text-muted mx-2">|</span>
                    <i class="fa fa-clock"></i> <%= site['walking_time'] %>
                  </p>
                  <p class="mb-0 small text-muted">
                    <strong>Risk:</strong> <%= site['risk_type']&.capitalize %>
                  </p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% rescue JSON::ParserError %>
      <!-- Invalid JSON, don't display anything -->
    <% end %>
  <% end %>

  <div class="d-grid gap-2 mb-3">
    <% if @ping.shared_at.present? %>
      <button class="btn btn-success btn-lg" disabled>
        <i class="fa fa-check-circle"></i> Shared on <%= @ping.shared_at.strftime("%B %d at %H:%M") %>
      </button>
    <% else %>
      <%= button_to share_ping_path(@ping), method: :post, class: "btn btn-primary btn-lg", data: { confirm: "Share this ping with the Pinger community within 300 meters?" } do %>
        <i class="fa fa-share-alt"></i> Share with Pinger
      <% end %>
    <% end %>
  </div>

  <%= link_to "Back to All Pings", pings_path, class: "btn btn-secondary" %>
</div>

<script>
  // Reverse geocoding to get address from coordinates
  const latitude = <%= @ping.latitude %>;
  const longitude = <%= @ping.longitude %>;

  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`)
    .then(response => response.json())
    .then(data => {
      const addressElement = document.getElementById('address-text');
      if (data.address) {
        const address = data.address;
        let shortAddress = [];

        // Add house number and street
        if (address.house_number) {
          shortAddress.push(address.house_number);
        }
        if (address.road || address.street) {
          shortAddress.push(address.road || address.street);
        }

        // Add city (try multiple possible keys)
        const city = address.city || address.town || address.village || address.municipality;
        if (city) {
          shortAddress.push(city);
        }

        // Add postcode
        if (address.postcode) {
          shortAddress.push(address.postcode);
        }

        if (shortAddress.length > 0) {
          addressElement.textContent = shortAddress.join(', ');
        } else {
          addressElement.textContent = data.display_name;
        }
        addressElement.classList.remove('text-muted');
      } else {
        addressElement.textContent = 'Address not available';
        addressElement.classList.add('text-muted');
      }
    })
    .catch(error => {
      console.error('Error fetching address:', error);
      document.getElementById('address-text').textContent = 'Unable to load address';
      document.getElementById('address-text').classList.add('text-muted');
    });
</script>

<div class="pingsafe-footer" data-map-footer-target="footer">
  <%= render "shared/footer2" %>
</div>
