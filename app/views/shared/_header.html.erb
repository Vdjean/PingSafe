<!-- Menu button -->
<span class="pingsafe-menu-btn" onclick="toggleNav(this)">
  <i class="fa-solid fa-list"></i>
</span>

<!-- SOS button -->
<%= button_tag type: 'button', class: 'pingsafe-nav-sos', id: 'sosButton', onclick: 'handleSosClick()' do %>
  <span>SOS</span>
<% end %>

<!-- Sidebar with latest pings -->
<%= render "shared/sidebar" %>

<!-- Sidebar overlay -->
<div class="pingsafe-sidenav-overlay" id="sidenavOverlay" onclick="closeNav()"></div>

<!-- SOS Alert -->
<div class="pingsafe-alert" id="sosAlert">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pingsafe-alert-icon">
    <circle cx="12" cy="12" r="10"/>
    <line x1="12" x2="12" y1="8" y2="12"/>
    <line x1="12" x2="12.01" y1="16" y2="16"/>
  </svg>
  <div class="pingsafe-alert-content">
    <p class="pingsafe-alert-title">Emergency?</p>
    <p class="pingsafe-alert-text" id="sosAlertText">Press again this button to call the police</p>
  </div>
</div>

<script>
let sosClickCount = 0;
let sosResetTimer = null;

function toggleNav(element) {
  const sidebar = document.getElementById("mySidenav");
  const menuBtn = element.closest('.pingsafe-menu-btn');

  if (sidebar.style.width === "280px") {
    closeNav();
  } else {
    openNav();
  }
}

function openNav() {
  const sidebar = document.getElementById("mySidenav");
  const menuBtn = document.querySelector('.pingsafe-menu-btn');
  const overlay = document.getElementById("sidenavOverlay");

  // Hide button immediately
  menuBtn.classList.add('hidden');

  // Small delay before showing sidenav to ensure button is fully hidden
  setTimeout(() => {
    sidebar.style.width = "280px";
    overlay.classList.add('active');
  }, 100);
}

function closeNav() {
  const sidebar = document.getElementById("mySidenav");
  const menuBtn = document.querySelector('.pingsafe-menu-btn');
  const overlay = document.getElementById("sidenavOverlay");

  // Close sidenav first
  sidebar.style.width = "0";
  overlay.classList.remove('active');

  // Show button after sidenav is fully closed
  setTimeout(() => {
    menuBtn.classList.remove('hidden');
  }, 500);
}

function handleSosClick() {
  const sosAlert = document.getElementById("sosAlert");
  const sosAlertText = document.getElementById("sosAlertText");

  sosClickCount++;

  if (sosClickCount === 1) {
    // First click: Show confirmation message
    sosAlertText.textContent = "Press again this button to call the police";
    sosAlert.style.display = "flex";

    // Reset after 10 seconds if not clicked again
    if (sosResetTimer) {
      clearTimeout(sosResetTimer);
    }
    sosResetTimer = setTimeout(() => {
      sosClickCount = 0;
      sosAlert.style.display = "none";
    }, 10000);

  } else if (sosClickCount === 2) {
    // Second click: Call the police
    sosAlertText.textContent = "Calling emergency services...";

    // Clear reset timer
    if (sosResetTimer) {
      clearTimeout(sosResetTimer);
    }

    // Make the call after a brief moment
    setTimeout(() => {
      window.location.href = 'tel:+3300';
      sosAlert.style.display = "none";
      sosClickCount = 0;
    }, 500);
  }
}
</script>
